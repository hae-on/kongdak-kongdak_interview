# 브라우저 렌더링 (Browser Rendering)

## 렌더링이란?

HTML, CSS, JS 등 개발자가 작성한 문서가 브라우저에서 출력되는 과정을 말합니다.

브라우저마다 각기 다른 렌더링 엔진을 가지고 있습니다.

렌더링 엔진을 통해 렌더링을 수행합니다.

## 렌더링 과정

1. 서버의 렌더링에 필요한 리소스(HTML, CSS, JS, 이미지 등) 요청한 뒤 응답 받기

브라우저는 입력받은 URL을 DNS(도메인 서버)를 통해 IP 주소로 변환 받고 해당 IP 주소 서버에 요청을 전달합니다.

<br />

2. HTML 파싱 후 DOM 트리 생성 (`무엇`을 그릴지 결정)

브라우저는 HTML 태그를 파싱해 DOM 트리를 구성합니다.

HTML은 서버로부터 `바이트` 형태로 전달받으며, 이후 문자열로 변환합니다.

`문자열`로 변환된 HTML은 각각 토큰으로 분해됩니다.

`토큰`으로 분해 된 HTML은 각각 `노드 객체`로 분해됩니다.

각각의 노드 객체가 부모-자식 관계를 형성하며 `트리 형태의 DOM`을 형성합니다.

<br />

3. CSS 파싱 후 CSSOM 생성 (`어떻게` 그릴지 결정)

HTML과 동일하게 파싱 과정이 `바이트 -> 문자열 -> 토큰 -> 노드` 과정으로 이루어집니다.

각각의 노드 객체가 부모-자식 관계를 형성하며 트리 형태의 `CSSOM`을 형성합니다.

HTML 파싱 중, CSS를 의미하는 link 태그나 style 태그를 만날 경우 `블로킹` 되어 CSSOM 생성으로 넘어갑니다.

CSSOM 생성이 마무리되면, 블로킹 된 시점부터 다시 HTML 파싱을 진행합니다.

<br />

4. 렌더링 트리 형성 (`화면에 그려질 것만` 결정)

DOM 트리와 CSSOM 트리가 만들어지면, 이 둘을 결합하여 렌더링 트리를 만듭니다.

렌더링 트리에는 페이지를 렌더링하는데 `필요한 노드만` 포함됩니다.

<br />

5. JavaScript 파싱과 실행

렌더링 엔진은 HTML 문서를 한 줄씩 순차적으로 파싱하며 DOM을 생성해 나가다가 자바스크립트 관련 태그(script)를 만나면 DOM 생성을 일시 중단합니다.

자바스크립트 코드를 파싱하기 위해 자바스크립트 엔진에 제어권을 넘깁니다.

제어권을 가진 자바스크립트 엔진은 자바스크립트 파일을 해석하여 `AST(Abstract syntax tree 추상적 구문 트리)`를 생성합니다.

```
** AST 생성 과정 **

1. JS 코드는 각각 의미를 갖는 토큰으로 분해됩니다.
2. 각 토큰은 서로 결합하여 AST를 형성합니다.
3. AST는 인터프리터가 실행할 수 있는 중간 코드인 바이트코드를 생성하여 실행합니다.
```

자바스크립트 파싱과 실행이 종료되면 제어권은 렌더링 엔진으로 넘어가고 HTML 파싱이 중지된 지점부터 다시 HTML 파싱을 진행합니다.

<br />

6. 레이아웃 단계 (`Box-Model`을 생성)

뷰포트 내에서 각 요소의 정확한 위치와 크기를 정확하게 캡처하는 BOX 모델이 출력됩니다.

모든 상대적인 측정값은 화면에서 `절대적인 픽셀`로 변환됩니다.

JS에 의해 노드가 추가되거나 브라우저 창이 리사이징되었을 경우 재레이아웃 및 재페인팅이 일어납니다.

<br />

7. 페인팅 단계

레이아웃 단계에서 모든 계산이 완료되면, 화면에 요소를 그립니다.

레이아웃 단계에서 각 노드의 위치, 크기 등이 모두 계산되었기 때문에 화면에 실제 픽셀로 변환하여 나타납니다.

<br />

- 리플로우와 리페인트

사용자가 웹 페이지에 최초 접속을 하면, 렌더링 과정이 일어나고 화면에 요소가 그려집니다.

이후 사용자의 인터랙션 또는 페이지의 기능에 따라 화면의 일부 영역에 변경이 발생합니다.

이에 영향을 받는 모든 노드에 대해 렌더링 트리 생성과 레이아웃 과정이 `다시` 수행됩니다.

이 과정을 `리플로우(Reflow)`라고 합니다.

리플로우된 결과를 화면에 그리기 위해서는 다시 페인팅 단계를 수행해야 합니다.
이 과정을 `리페인트(Repaint)`라고 합니다.

기존 요소가 변경되었다고 항상 리플로우-리페인트가 일어나는 것은 아닙니다.

레이아웃에 영향을 미치지 않는 변경사항은 리플로우 없이 리페인트만 일어납니다.
(리플로우가 발생하면 리페인트는 반드시 발생합니다)
